# Go SDK Release: Lint, Test, Auto-tag, GoReleaser
# Based on jacaudi/github-actions example-go-sdk-release.yml
name: Release

on:
  push:  # Run on all branch pushes
  pull_request:

permissions:
  contents: write
  packages: write

jobs:
  lint:
    # Skip on tag pushes - code should have been tested already
    if: "!startsWith(github.ref, 'refs/tags/v')"
    uses: jacaudi/github-actions/.github/workflows/lint.yml@v0.1.4
    with:
      go: true
      go-version: 'stable'

  test:
    # Skip on tag pushes - code should have been tested already
    if: "!startsWith(github.ref, 'refs/tags/v')"
    uses: jacaudi/github-actions/.github/workflows/test.yml@v0.1.4
    with:
      framework: go
      coverage: true
      go-version: 'stable'

  # Automatic versioning from Conventional Commits
  # Creates version tags automatically based on commit messages:
  # - feat: ... → minor version bump (v1.1.0)
  # - fix: ... → patch version bump (v1.0.1)
  # - feat!: or fix!: or BREAKING CHANGE → major version bump (v2.0.0)
  version:
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: jacaudi/github-actions/.github/workflows/uplift.yml@v0.1.4
    with:
      use-github-app: true
    secrets:
      app-id: ${{ secrets.APP_ID }}
      app-private-key: ${{ secrets.APP_PRIVATE_KEY }}

  # Release automatically after uplift creates version tag
  release:
    needs: [lint, test, version]
    if: needs.version.outputs.released == 'true'
    uses: jacaudi/github-actions/.github/workflows/goreleaser.yml@v0.1.4
    with:
      go-version: 'stable'
      goreleaser-config: '.goreleaser.yaml'
      release-tag: ${{ needs.version.outputs.version }}

  # Manual release on tag push (disabled - using automatic versioning)
  # Uncomment this and comment out the release/version jobs above for manual tagging
  # release-manual:
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   uses: jacaudi/github-actions/.github/workflows/goreleaser.yml@v0.1.4
  #   with:
  #     go-version: 'stable'
  #     goreleaser-config: '.goreleaser.yaml'
