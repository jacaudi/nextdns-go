# Go SDK Release: Lint, Test, Semantic Release + GoReleaser
# Based on jacaudi/github-actions v0.2.0
name: Release

on:
  push:  # Run on all branch pushes
  pull_request:

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  lint:
    # Skip on tag pushes - code should have been tested already
    if: "!startsWith(github.ref, 'refs/tags/v')"
    uses: jacaudi/github-actions/.github/workflows/lint.yml@v0.8.0
    with:
      go: true
      go-version: 'stable'

  test:
    # Skip on tag pushes - code should have been tested already
    if: "!startsWith(github.ref, 'refs/tags/v')"
    uses: jacaudi/github-actions/.github/workflows/test.yml@v0.8.0
    with:
      test-framework: go
      coverage: true
      go-version: 'stable'

  # Automatic semantic versioning from Conventional Commits + GoReleaser build
  # Creates version tags and releases automatically based on commit messages:
  # - feat: ... → minor version bump (v1.1.0)
  # - fix: ... → patch version bump (v1.0.1)
  # - feat!: ... → major version bump (v2.0.0) [native breaking change support]
  # GoReleaser runs as a hook after semantic-release creates the tag
  release:
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: jacaudi/github-actions/.github/workflows/semantic-release.yml@v0.8.0
    with:
      use-github-app: true
      hooks: goreleaser
    secrets:
      app-id: ${{ secrets.APP_ID }}
      app-private-key: ${{ secrets.APP_PRIVATE_KEY }}
